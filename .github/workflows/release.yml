name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.3)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"
      
      - name: Verify version matches package.json
        id: verify_version
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "⚠️  Warning: Tag version (${{ steps.version.outputs.version }}) doesn't match package.json ($PKG_VERSION)"
            echo "Proceeding anyway..."
          fi
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Build and zip extension
        run: bun run zip
      
      - name: Get ZIP filename
        id: zip_file
        run: |
          ZIP_FILE=$(ls .output/*-chrome.zip | head -n 1)
          ZIP_NAME=$(basename "$ZIP_FILE")
          echo "file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "ZIP file: $ZIP_FILE"
          echo "ZIP name: $ZIP_NAME"
      
      - name: Extract changelog for release
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract the latest changelog entry (everything from first ## [version] to next ## or end)
            awk '/^## \[/{if(p) exit; p=1} p' CHANGELOG.md | sed '/^## \[/d' > /tmp/changelog_section.md
            if [ ! -s /tmp/changelog_section.md ]; then
              echo "See the commit history for details." > /tmp/changelog_section.md
            fi
          else
            echo "See the commit history for details." > /tmp/changelog_section.md
          fi
      
      - name: Create GitHub Release
        id: create_release
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          
          # Check if release already exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Skipping creation."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            cat > /tmp/release_notes.md << EOF
          $(cat /tmp/changelog_section.md)
          
          ## Downloads
          
          - Chrome Web Store ZIP: \`${{ steps.zip_file.outputs.name }}\`
          EOF
          
            gh release create "$TAG" \
              --title "Release $TAG" \
              --notes-file /tmp/release_notes.md \
              "${{ steps.zip_file.outputs.file }}"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
      
      - name: Submit to Chrome Web Store
        run: |
          bunx wxt submit \
            --chrome-zip ${{ steps.zip_file.outputs.file }}
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

